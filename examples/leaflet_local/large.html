<html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="/dist/flatgeobuf-geojson.min.js"></script>
    <script src="https://unpkg.com/json-formatter-js"></script>

    <style>
        #map { height: 480px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="header">
        <h3>Parsed header content</h3>
    </div>
    <script>
		document.addEventListener("DOMContentLoaded", async () => { 
			// basic OSM Leaflet map
			let map = L.map('map').setView([41.505, -80.09], 4);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			function handleHeaderMeta(headerMeta) {
				const header = document.getElementById('header')
				const formatter = new JSONFormatter(headerMeta, 10)
				header.appendChild(formatter.render())
			}

			const boundingRect = {
				minX: -102.1,
				maxX: -102.0,
				minY: 44,
				maxY: 44.01,
			};

			// use flatgeobuf JavaScript API to iterate features as geojson
			// NOTE: would be more efficient with a special purpose Leaflet deserializer
			let iter = flatgeobuf.deserialize('https://s3.amazonaws.com/mjk_asdf/abs/population_areas.fgb', boundingRect, handleHeaderMeta);
			for await (let feature of iter) {
				L.geoJSON(feature).addTo(map);
			}
		});
    </script>
</body>
</html>
